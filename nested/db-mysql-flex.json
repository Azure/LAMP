{
    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
        "lampCommon": {
            "metadata": {
                "description": "Common LAMP values"
            },
            "type": "object"
        },
        "subnetIdFlexDb": {
            "metadata": {
                "description": "Azure resource ID of the subnet where flex DB for MySQL instance is to be deligated"
            },
            "type": "string"
        },
        "serverParameters": {
            "type": "Object",
            "defaultValue": {
                "parameters": [
                    {
                        "name": "require_secure_transport",
                        "value": "OFF",
                        "source": "user-override"
                    }
                ]
            }
        }
    },
    "resources": [
        {
            "apiVersion": "2018-09-01",
            "type": "Microsoft.Network/privateDnsZones",
            "name": "[variables('flexDbPrivateDnsZoneName')]",
            "location": "global",
            "tags": {},
            "properties": {}
        },
        {
            "apiVersion": "2020-06-01",
            "type": "Microsoft.Network/privateDnsZones/virtualNetworkLinks",
            "name": "[concat(variables('flexDbPrivateDnsZoneName'), '/', variables('virtualNetworkLinksName'))]",
            "location": "global",
            "dependsOn": [
                "[resourceId('Microsoft.Network/privateDnsZones', variables('flexDbPrivateDnsZoneName'))]"
            ],
            "properties": {
                "virtualNetwork": {
                    "id": "[variables('vnetId')]"
                },
                "registrationEnabled": false
            }
        },
        {
            "apiVersion": "2021-05-01",
            "type": "Microsoft.DBforMySQL/flexibleServers",
            "location": "[parameters('lampCommon').location]",
            "name": "[parameters('lampCommon').serverName]",
            "dependsOn": [
                "[resourceId('Microsoft.Network/privateDnsZones/virtualNetworkLinks', variables('flexDbPrivateDnsZoneName'), variables('virtualNetworkLinksName'))]"
            ],
            "properties": {
                "version": "[parameters('lampCommon').mysqlVersion]",
                "administratorLogin": "[parameters('lampCommon').dbLogin]",
                "administratorLoginPassword": "[parameters('lampCommon').dbLoginPassword]",
                "sslEnforcement": "[parameters('lampCommon').sslEnforcement]",                
                "Network": {
                    "delegatedSubnetResourceId": "[parameters('subnetIdFlexDb')]",
                    "privateDnsZoneResourceId": "[variables('privateDnsZoneResourceId')]"
                },
                "Storage": {
                    "storageSizeGB": "[parameters('lampCommon').mysqlPgresStgSizeGB]",
                    "iops": "[parameters('lampCommon').mysqlPgresStorageIops]"
                },
                "Backup": {
                    "backupRetentionDays": "[parameters('lampCommon').mysqlPgresBackupRetentionDays]",
                    "geoRedundantBackup": "Disabled"
                },
                "availabilityZone": "",
                "highAvailability": {
                    "mode": "[parameters('lampCommon').mysqlPgresHighAvailabilityMode]",
                    "standbyAvailabilityZone": ""
                }
            },
            "sku": {
                "name": "[parameters('lampCommon').mysqlPgresComputeSize]",
                "tier": "[parameters('lampCommon').mysqlPgresSkuTier]",
                "capacity": "[parameters('lampCommon').mysqlPgresVcores]"
            },
            "resources": [
                {
                    "type": "Microsoft.DBforMySQL/flexibleServers/configurations",
                    "apiVersion": "2021-05-01",
                    "name": "[variables('flexConfigName')]",
                    "dependsOn": [
                        "[concat('Microsoft.DBforMySQL/flexibleServers/', parameters('lampCommon').serverName)]"
                    ],
                    "properties": {
                        "value": "[parameters('serverParameters').parameters[0].value]",
                        "source": "[parameters('serverParameters').parameters[0].source]"
                    }
                }
            ]
        }
    ],
    "outputs": {
        "dbFQDN": {
            "type": "string",
            "value": "[concat(parameters('lampCommon').serverName, parameters('lampCommon').flexDbDomainName)]"
        }
    },
    "variables": {
        "flexConfigName": "[concat(parameters('lampCommon').serverName, '/', parameters('serverParameters').parameters[0].name)]",
        "flexDbPrivateDnsZoneName": "[concat(parameters('lampCommon').serverName, '.private.mysql.database.azure.com')]",
        "vnetId": "[take(parameters('subnetIdFlexDb'), indexOf(parameters('subnetIdFlexDb'),'/subnets/'))]",
        "virtualNetworkLinksName": "[uniqueString(variables('vnetId'))]",
        "privateDnsZoneResourceId": "[resourceId('Microsoft.Network/privateDnsZones', variables('flexDbPrivateDnsZoneName'))]",
        "documentation1": "This sub-template creates a mysql server.  It expects certain values in the 'common' datastructure.",
        "documentation10": " serverName                 - Mysql server name",
        "documentation11": " mysqlVersion               - Mysql version",
        "documentation2": " administratorLogin          - mysql admin username",
        "documentation3": " administratorLoginPassword  - mysql admin password",
        "documentation4": " location                    - Mysql server location",
        "documentation5": " mysqlPgresVcores            - Mysql database trasaction units",
        "documentation7": " mysqlPgresSkuName           - Mysql sku name",
        "documentation8": " mysqlPgresStgSizeGB         - Mysql sku size in mb",
        "documentation9": " mysqlPgresSkuTier           - Mysql sku tier",
        "documentationA": " mysqlPgresSkuHwFamily       - Mysql sku hardware family"
    }
}